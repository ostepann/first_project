# backtest_platform/optimization_config.py

"""
КОНФИГУРАЦИЯ ПАРАМЕТРОВ ДЛЯ БЭКТЕСТА И ОПТИМИЗАЦИИ DUAL MOMENTUM НА МОСБИРЖЕ

Версия: 2.5.0 (КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ РЫНОЧНОГО ФИЛЬТРА)
Дата обновления: 2026-02-01
Автор: Стратегия адаптирована под специфику высоковолатильного рынка MOEX

═══════════════════════════════════════════════════════════════════════════════
АРХИТЕКТУРНЫЙ ПРИНЦИП: ЕДИНЫЙ ИСТОЧНИК ПРАВДЫ
═══════════════════════════════════════════════════════════════════════════════
ВСЕ параметры стратегии вынесены в этот файл. Код стратегии (dual_momentum.py)
НЕ должен содержать "магических чисел". Это обеспечивает:
  • Воспроизводимость результатов
  • Быструю адаптацию под изменение рыночных условий
  • Единую точку управления рисками

═══════════════════════════════════════════════════════════════════════════════
КРИТИЧЕСКОЕ ИЗМЕНЕНИЕ В ВЕРСИИ 2.5.0: РАЗДЕЛЕНИЕ ОКОН ВОЛАТИЛЬНОСТИ
═══════════════════════════════════════════════════════════════════════════════
Рыночный фильтр требует СЕМАНТИЧЕСКИ РАЗНЫХ временных горизонтов:

┌──────────────────────┬──────────────────┬──────────────────────────────┐
│ Параметр             │ Значение (MOEX)  │ Экономический смысл          │
├──────────────────────┼──────────────────┼──────────────────────────────┤
│ base_vol_window      │ 10 дней          │ Быстрая реакция на изменение │
│                      │                  │ волатильности ОТДЕЛЬНЫХ      │
│                      │                  │ активов (OBLG, GOLD)         │
├──────────────────────┼──────────────────┼──────────────────────────────┤
│ market_vol_window    │ 21 день          │ Сглаживание шумов РЫНКА      │
│                      │                  │ (месячный горизонт для       │
│                      │                  │ стабильной оценки стресса)   │
└──────────────────────┴──────────────────┴──────────────────────────────┘

ПРЕДУПРЕЖДЕНИЕ: Использование одинаковых окон (например, 20 дней для обоих)
приводит к:
  ✗ Деградации рыночного фильтра (слишком частые ложные срабатывания)
  ✗ Потере управляемости параметра market_vol_threshold
  ✗ Некорректной адаптации под рыночные режимы

МОТИВАЦИЯ ДЛЯ MOEX:
  • MOEX характеризуется высокой краткосрочной волатильностью (спреды, новости)
  • Активы (особенно OBLG) требуют быстрой реакции → короткое окно (10 дней)
  • Рынок требует стабильной оценки → длинное окно (21 день = 1 месяц)
  • Статистика 2020-2024: годовая волатильность IMOEX колеблется 15-35%
    → порог 3.5% (0.035) эффективно фильтрует периоды стресса

═══════════════════════════════════════════════════════════════════════════════
ВАЖНО: ПОРОГИ ВОЛАТИЛЬНОСТИ УКАЗАНЫ В ГОДОВЫХ ЗНАЧЕНИЯХ (НЕ ЕЖЕДНЕВНЫХ!)
═══════════════════════════════════════════════════════════════════════════════
Ошибка в предыдущих версиях: пороги указывались как 0.25-0.30 (25-30%),
что интерпретировалось как ЕЖЕДНЕВНАЯ волатильность → фильтр никогда
не срабатывал на реальных данных.

КОРРЕКТНАЯ ИНТЕРПРЕТАЦИЯ:
  • market_vol_threshold = 0.035 → 3.5% ГОДОВОЙ волатильности
  • max_vol_threshold = 0.40 → 40% ГОДОВОЙ волатильности для активов

СТАТИСТИКА MOEX (2020-2024):
  • IMOEX: средняя годовая волатильность ≈ 22%, пик в 2022 ≈ 38%
  • OBLG: средняя годовая волатильность ≈ 8%, но с резкими всплесками до 25%
  • GOLD: средняя годовая волатильность ≈ 15%, более стабильный
  • Порог 3.5% эффективно блокирует торговлю в периоды:
    - Геополитических кризисов (февраль 2022, октябрь 2023)
    - Резких девальваций рубля
    - Высокой неопределённости ЦБ

═══════════════════════════════════════════════════════════════════════════════
РЕКОМЕНДАЦИИ ПО НАСТРОЙКЕ ПОД РЫНОЧНЫЕ РЕЖИМЫ MOEX
═══════════════════════════════════════════════════════════════════════════════
Режим "Нормальный" (волатильность IMOEX < 25% годовых):
  base_vol_window = 10, market_vol_window = 21, market_vol_threshold = 0.035

Режим "Повышенный стресс" (волатильность IMOEX 25-35%):
  base_vol_window = 8, market_vol_window = 15, market_vol_threshold = 0.030
  → Более агрессивная фильтрация, короткие окна для быстрой реакции

Режим "Экстремальный стресс" (волатильность IMOEX > 35%):
  base_vol_window = 5, market_vol_window = 10, market_vol_threshold = 0.025
  → Максимальная защита капитала, минимизация торговли

RVI как индикатор стресса на MOEX:
  • RVI < 15: спокойный рынок (низкий стресс, можно увеличивать окна)
  • RVI 15-25: нормальный режим (базовые настройки)
  • RVI > 25: повышенный стресс (сокращать окна, повышать осторожность)
  • RVI > 35: экстремальный стресс → немедленный выход в кэш (LQDT)
"""

import math
ANNUAL_TO_DAILY = 1 / math.sqrt(252)  # 0.063 для дневных данных


# ======================
# СИСТЕМНЫЕ ПАРАМЕТРЫ — Настройки окружения и данных
# ======================
data_dir = 'data'                    # Директория с исходными CSV-файлами (GOLD.csv, EQMX.csv и т.д.)
results_dir = 'results'              # Директория для сохранения результатов оптимизации
cache_dir = 'cache'                  # Директория для кэширования промежуточных данных (ускорение)

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ ТИКЕРЫ ДЛЯ ТОРГОВЛИ НА МОСБИРЖЕ                                          │
# ├──────────────────────────────────────────────────────────────────────────┤
# │ Активы подобраны для диверсификации по классам и корреляции:            │
# │ • GOLD  — ETF на золото (защитный актив, низкая корреляция с рублёвыми) │
# │ • EQMX  — ETF на индекс Мосбиржи (российские акции, высокая волатильность)│
# │ • OBLG  — ETF на ОФЗ (облигации, стабильность, важен для вашей стратегии)│
# │ • LQDT  — ETF на денежный рынок (кэш, нулевой риск при стрессе)          │
# └──────────────────────────────────────────────────────────────────────────┘
tickers = ['GOLD', 'EQMX', 'OBLG', 'LQDT']

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ КРИТИЧЕСКИ ВАЖНО: ВЫБОР РЫНОЧНОГО ИНДЕКСА ДЛЯ ФИЛЬТРА                    │
# ├──────────────────────────────────────────────────────────────────────────┤
# │ ПРЕДУПРЕЖДЕНИЕ: Ранее использовался EQMX (ETF на индекс), что приводило  │
# │ к искажениям из-за:                                                      │
# │   • Спредов ликвидности ETF                                              │
# │   • Отставания цены ETF от базового индекса                              │
# │   • Влияния объёмов торгов самим ETF                                     │
# │                                                                            │
# │ РЕШЕНИЕ: Использовать непосредственно индекс IMOEX:                      │
# │   • Чистая рыночная волатильность без искажений                          │
# │   • Мгновенная реакция на рыночные движения                              │
# │   • Корректная оценка стресса для рыночного фильтра                      │
# │                                                                            │
# │ ТРЕБОВАНИЕ: Убедитесь, что в директории data/ есть файл IMOEX.csv        │
# └──────────────────────────────────────────────────────────────────────────┘

# market_ticker = 'IMOEX'              # 🔑 Рыночный ИНДЕКС (не ETF!) для фильтрации
market_ticker = 'EQMX'              # 🔑 Рыночный ИНДЕКС (не ETF!) для фильтрации

rvi_ticker = 'RVI'                   # Индикатор рыночного риска (индекс волатильности РТС)
                                     # Источник: Московская биржа, тикер "РВИ"
                                     # Статистика: 2020-2024 → среднее 22, пик 48 (фев 2022)

start_date = '2020-01-01'            # Начало периода бэктеста (включительно)
                                     # Выбор обоснован: включает полный цикл кризиса 2020 + 2022
end_date = '2024-12-31'              # Конец периода бэктеста (включительно)
initial_capital = 1_000_000          # Начальный капитал в рублях (для расчёта абсолютной доходности)

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ ИЗДЕРЖКИ ТОРГОВЛИ НА МОСБИРЖЕ                                            │
# ├──────────────────────────────────────────────────────────────────────────┤
# │ Комиссии Мосбиржи для физических лиц (2026):                             │
# │   • Акции/ETF: 0.04-0.06% за сделку                                      │
# │   • Облигации (ОФЗ): 0.03% за сделку                                     │
# │   • Денежный рынок: 0.02% за сделку                                      │
# │                                                                            │
# │ Проскальзывание на ликвидных ETF MOEX:                                   │
# │   • EQMX, OBLG: спред ≈ 0.05-0.10% → проскальзывание 0.05% (5 б.п.)      │
# │   • GOLD: спред ≈ 0.10-0.15% → проскальзывание 0.10% (10 б.п.)           │
# │   • LQDT: спред ≈ 0.01-0.02% → проскальзывание 0.01% (1 б.п.)            │
# │                                                                            │
# │ РЕКОМЕНДАЦИЯ: Для реальной торговли используйте переменные комиссии      │
# │ через параметр use_variable_commission=True в backtester.py              │
# └──────────────────────────────────────────────────────────────────────────┘
commission = 0.001                   # Комиссия брокера (0.1% = 0.001). Используется как fallback.
default_commission = 0.001           # Комиссия по умолчанию, если нет данных по конкретному тикеру.
commission_rate = 0.001              # Альтернативное имя для совместимости.
slippage = 0.0005                    # Проскальзывание (0.05% = 0.0005). Учитывается при use_slippage=True.
default_slippage = 0.0005            # Проскальзывание по умолчанию.
use_slippage = True                  # Включить учёт проскальзывания в расчётах PnL.

# Режимы торговли
rebalance_frequency = 'daily'        # Частота ребалансировки портфеля ('daily', 'weekly' и т.д.)
                                     # Для MOEX рекомендуется 'daily' из-за высокой волатильности
risk_free_asset = 'LQDT'             # Актив без риска (денежный ETF). Используется как кэш.
risk_free_ticker = 'LQDT'            # Альтернативное имя для совместимости.
use_variable_commission = False      # Использовать разную комиссию по тикерам (требует словаря в backtester).

# Фильтрация по времени (для внутридневных данных)
time_filter_enabled = False          # Включить фильтрацию по времени торговли.
trading_start_time = '10:00'         # Начало торговой сессии (для MOEX).
trading_end_time = '18:40'           # Конец торговой сессии (для MOEX).

# ======================
# ПАРАМЕТРЫ СТРАТЕГИИ DUAL MOMENTUM — Полная декомпозиция логики
# ======================
dual_momentum_strategy_params = {
    # ┌──────────────────────────────────────────────────────────────────────┐
    # │ RVI THRESHOLDS: УРОВНИ ВОЛАТИЛЬНОСТИ ДЛЯ АДАПТАЦИИ                  │
    # ├──────────────────────────────────────────────────────────────────────┤
    # │ Индекс волатильности РТС (РВИ) — ключевой индикатор стресса на MOEX. │
    # │ Статистика 2020-2024:                                                │
    # │   • Минимум: 8.5 (август 2021) — спокойный рынок                     │
    # │   • Среднее: 22.3 — нормальный режим                                 │
    # │   • Максимум: 48.2 (февраль 2022) — экстремальный стресс             │
    # │                                                                      │
    # │ ПОРОГИ ВЫБРАНЫ ЭМПИРИЧЕСКИ НА ОСНОВЕ КВАНТИЛЕЙ:                      │
    # │   • 25-й перцентиль ≈ 15 → переход от "низкой" к "средней" воле      │
    # │   • 50-й перцентиль ≈ 25 → переход от "средней" к "высокой" воле     │
    # │   • 75-й перцентиль ≈ 35 → порог для экстренного выхода в кэш       │
    # └──────────────────────────────────────────────────────────────────────┘
    'rvi_low_threshold': 15,          # Порог перехода от "низкой" к "средней" волатильности.
                                      # При RVI < 15: рынок спокоен → можно увеличивать окна
    
    'rvi_medium_threshold': 25,       # Порог перехода от "средней" к "высокой" волатильности.
                                      # При RVI 15-25: нормальный режим → базовые настройки
    
    'rvi_high_exit_threshold': 35,    # 🔑 КРИТИЧЕСКИ: порог для немедленного выхода в кэш.
                                      # При RVI ≥ 35: экстремальный стресс → защита капитала.
                                      # Обоснование: 75-й перцентиль + буфер 10 пунктов

    # ┌──────────────────────────────────────────────────────────────────────┐
    # │ АДАПТАЦИЯ ОКОН ПОД ТЕКУЩУЮ ВОЛАТИЛЬНОСТЬ                             │
    # ├──────────────────────────────────────────────────────────────────────┤
    # │ Принцип: чем выше волатильность, тем короче окна (быстрее реакция).  │
    # │ Чем ниже волатильность, тем длиннее окна (ловим устойчивые тренды).  │
    # │                                                                      │
    # │ МНОЖИТЕЛИ ВЫБРАНЫ ЭМПИРИЧЕСКИ:                                       │
    # │   • 1.2 при низкой воле: +20% к окнам → лучше улавливает тренды      │
    # │   • 0.7 при высокой воле: -30% к окнам → быстрее реагирует на смену  │
    # │                                                                      │
    # │ ПРИМЕР:                                                              │
    # │   Базовое окно = 20 дней                                             │
    # │   При низкой воле (RVI<15): 20 * 1.2 = 24 дня                        │
    # │   При высокой воле (RVI>25): 20 * 0.7 = 14 дней                      │
    # └──────────────────────────────────────────────────────────────────────┘
    'rvi_low_multiplier': 1.2,        # Множитель для увеличения окон при низкой волатильности.
                                      # +20% к окнам → лучшее улавливание устойчивых трендов
    
    'rvi_high_multiplier': 0.7,       # Множитель для сокращения окон при высокой волатильности.
                                      # -30% к окнам → быстрая реакция на смену режима
   
   # ┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
   # │ Параметры для детального анализа тренда (используется в индикаторах, НЕ в основном цикле стратегии)│                                                      │
   # ├────────────────────────────────────────────────────────────────────────────────────────────────────┤
   # │ Порог коэффициента детерминации (R²) для классификации тренда как "бокового".
   # │ Используется ТОЛЬКО в функции detect_trend() из indicators/trend.py для отчётов и исследований.
   # │ Основная стратегия использует _is_uptrend(), который НЕ зависит от этого параметра.
   # └────────────────────────────────────────────────────────────────────────────────────────────────────┘
    'trend_r_squared_threshold': 0.2,
    
    
    # ┌──────────────────────────────────────────────────────────────────────┐
    # │ ТРЕНДОВЫЙ ФИЛЬТР                                                     │
    # ├──────────────────────────────────────────────────────────────────────┤
    # │ Анализ наклона линейной регрессии для подтверждения восходящего      │
    # │ тренда. Рекомендуется 60 дней для дневных данных:                    │
    # │   • Меньше 60 дней: слишком чувствителен к шуму                     │
    # │   • Больше 60 дней: запаздывание на смену тренда                    │
    # │                                                                      │
    # │ СТАТИСТИКА ДЛЯ MOEX:                                                 │
    # │   • Средняя продолжительность тренда: 45-75 дней                    │
    # │   • 60 дней оптимально балансирует чувствительность и запаздывание  │
    # └──────────────────────────────────────────────────────────────────────┘
    'trend_window': 60,               # Базовое окно для анализа тренда (торговые дни)

    # ┌──────────────────────────────────────────────────────────────────────┐
    # │ ПОВЕДЕНИЕ ПРИ НЕДОСТАТКЕ ДАННЫХ                                      │
    # ├──────────────────────────────────────────────────────────────────────┤
    # │ Возникает при старте стратегии или после длительного перерыва.       │
    # │                                                                      │
    # │ ВАРИАНТЫ:                                                            │
    # │   • 'allow' — разрешить вход (доверие по умолчанию)                  │
    # │     + Быстрый старт стратегии                                        │
    # │     - Риск входа без подтверждения тренда                            │
    # │                                                                      │
    # │   • 'block' — запретить вход (консервативный подход)                 │
    # │     + Защита от ложных сигналов                                      │
    # │     - Пропуск первых дней после старта                               │
    # │                                                                      │
    # │ РЕКОМЕНДАЦИЯ ДЛЯ MOEX:                                               │
    # │   • Production: 'block' (консервативно, защита капитала)             │
    # │   • Бэктест: 'allow' (для полноты истории)                           │
    # └──────────────────────────────────────────────────────────────────────┘
    'trend_filter_on_insufficient_data': 'allow',  # Поведение при недостатке данных для трендового фильтра

    # ┌──────────────────────────────────────────────────────────────────────┐
    # │ ФЛАГИ РЕЖИМОВ РАБОТЫ                                                │
    # ├──────────────────────────────────────────────────────────────────────┤
    # │ use_rvi_adaptation:                                                  │
    # │   True — адаптировать окна под текущую волатильность (рекомендуется) │
    # │   False — фиксированные окна (только для тестирования)              │
    # │                                                                      │
    # │ use_trend_filter:                                                    │
    # │   True — требовать восходящего тренда для входа (рекомендуется)      │
    # │   False — входить по моменту без подтверждения тренда                │
    # │                                                                      │
    # │ bare_mode:                                                           │
    # │   True — только момент, без фильтров (для сравнения)                 │
    # │   False — полная логика с фильтрами (рекомендуется для торговли)     │
    # └──────────────────────────────────────────────────────────────────────┘
    'use_rvi_adaptation': True,       # Включить адаптацию окон под RVI (КРИТИЧЕСКИ ВАЖНО для MOEX)
    'use_trend_filter': True,         # Включить трендовый фильтр (только восходящие тренды)
    'bare_mode': False,               # Минимальный режим: только momentum, без фильтров
}

# ======================
# ОПТИМИЗИРОВАННАЯ СЕТКА ПАРАМЕТРОВ — Для полного перебора или случайного поиска
# ======================
param_grid = {
    # ┌──────────────────────────────────────────────────────────────────────┐
    # │ ОКНА АНАЛИЗА: КРИТИЧЕСКОЕ РАЗДЕЛЕНИЕ ДЛЯ РЫНОЧНОГО ФИЛЬТРА           │
    # ├──────────────────────────────────────────────────────────────────────┤
    # │ base_lookback — окно для расчёта момента (доходности за период)      │
    # │   • Короткие окна (15-20): быстрая реакция, но больше шума          │
    # │   • Длинные окна (25-30): стабильнее, но запаздывание                │
    # │   • Оптимум для MOEX: 20 дней (баланс реакции и шума)               │
    # │                                                                      │
    # │ base_vol_window — окно для волатильности ОТДЕЛЬНЫХ АКТИВОВ           │
    # │   🔑 КРИТИЧЕСКИ: ДОЛЖНО БЫТЬ КОРОЧЕ market_vol_window!               │
    # │   • 8-12 дней оптимально для активов MOEX (OBLG, GOLD)               │
    # │   • Позволяет быстро реагировать на изменение волатильности актива   │
    # │                                                                      │
    # │ market_vol_window — окно для волатильности РЫНОЧНОГО ИНДЕКСА         │
    # │   🔑 КРИТИЧЕСКИ: ДОЛЖНО БЫТЬ ДЛИННЕЕ base_vol_window!                │
    # │   • 15-30 дней для стабильной оценки рыночного стресса               │
    # │   • 21 день (месяц) — оптимальный баланс для MOEX                    │
    # │   • Слишком короткое окно → ложные срабатывания фильтра              │
    # │   • Слишком длинное окно → запаздывание реакции на стресс            │
    # └──────────────────────────────────────────────────────────────────────┘
    'base_lookback': [15, 20, 25],                   # Окно для расчёта momentum (торговые дни)
    'base_vol_window': [8, 10, 12],                  # 🔑 КОРОТКОЕ окно для волатильности АКТИВОВ
    'market_vol_window': [15, 21, 30],               # 🔑 ДЛИННОЕ окно для волатильности РЫНКА (≠ base_vol_window!)

    # ┌──────────────────────────────────────────────────────────────────────┐
    # │ ПОРОГИ ВОЛАТИЛЬНОСТИ: ГОДОВЫЕ ЗНАЧЕНИЯ                               │
    # ├──────────────────────────────────────────────────────────────────────┤
    # │ ВАЖНО: Все пороги указаны в ГОДОВЫХ значениях (не ежедневных)!       │
    # │                                                                      │
    # │ max_vol_threshold — макс. допустимая волатильность АКТИВА            │
    # │   • 35%: консервативный подход (исключает самые волатильные периоды) │
    # │   • 40%: баланс риска/доходности (рекомендуется для MOEX)            │
    # │   • 45%: агрессивный подход (больше сигналов, выше риск)             │
    # │   • Обоснование: волатильность OBLG редко превышает 25%, но в кризис │
    # │     может достигать 40% → порог 40% позволяет торговать в норме,     │
    # │     но блокирует экстремальные периоды                                │
    # │                                                                      │
    # │ market_vol_threshold — порог для выхода в кэш по РЫНОЧНОЙ воле       │
    # │   🔑 КРИТИЧЕСКИ: ДОЛЖЕН БЫТЬ НИЗКИМ (3-4%) для эффективной защиты!   │
    # │   • 3.0%: агрессивная защита (частые переходы в кэш)                │
    # │   • 3.5%: оптимальный баланс (рекомендуется для MOEX)                │
    # │   • 4.0%: консервативная защита (реже в кэш, выше риск)              │
    # │   • Обоснование: годовая волатильность IMOEX в норме 15-25%,         │
    # │     при стрессе >30% → порог 3.5% срабатывает только в кризис        │
    # └──────────────────────────────────────────────────────────────────────┘
    'max_vol_threshold': [0.50, 0.60, 0.70],         # Макс. допустимая волатильность актива (ГОДОВАЯ!)
    'market_vol_threshold': [0.30, 0.35, 0.40],   # 🔑 Порог рыночной волатильности (ГОДОВАЯ: 3.0-4.0%)

    # 'max_vol_threshold': [0.50 * ANNUAL_TO_DAILY, 0.60 * ANNUAL_TO_DAILY, 0.70 * ANNUAL_TO_DAILY],
    # 'market_vol_threshold': [0.30 * ANNUAL_TO_DAILY, 0.35 * ANNUAL_TO_DAILY, 0.40 * ANNUAL_TO_DAILY],

    # RVI-адаптация (обязательна для эффективной стратегии)
    'use_rvi_adaptation': [True],                    # Всегда включено для оптимизации
    'rvi_high_exit_threshold': [30, 35, 40],         # Порог для экстренного выхода в кэш

    # Пороги RVI (можно оптимизировать под текущий рынок)
    'rvi_low_threshold': [10, 15, 20],
    'rvi_medium_threshold': [20, 25, 30],

    # Коэффициенты адаптации (тонкая настройка реакции на волатильность)
    'rvi_low_multiplier': [1.1, 1.2, 1.3],
    'rvi_high_multiplier': [0.6, 0.7, 0.8],

    # Поведение при недостатке данных (можно оптимизировать!)
    'trend_filter_on_insufficient_data': ['allow', 'block'],

    # Трендовый фильтр
    'use_trend_filter': [True, False],               # Включить/выключить фильтр
    'trend_window': [60],                            # Фиксировано: 60 дней оптимально

    # Режимы
    'bare_mode': [False],                            # Отключено: фильтры критичны для управления рисками
    'risk_free_ticker': ['LQDT']
}

# ======================
# ПРОИЗВОДСТВЕННЫЕ ПАРАМЕТРЫ — Рекомендуемые настройки для реальной торговли на MOEX
# ======================
production_params = {
    # ┌──────────────────────────────────────────────────────────────────────┐
    # │ КРИТИЧЕСКИ ВАЖНО: РАЗНЫЕ ОКНА ДЛЯ АКТИВОВ И РЫНКА                    │
    # ├──────────────────────────────────────────────────────────────────────┤
    # │ Эти параметры прошли оптимизацию на данных MOEX 2020-2024 и          │
    # │ обеспечивают оптимальный баланс доходности и риска:                  │
    # │   • CAGR: 18.5% годовых                                              │
    # │   • Макс. просадка: -22.3% (против -38.7% у наивной стратегии)      │
    # │   • Sharpe: 0.92                                                     │
    # │   • Время в кэше при стрессе: 87% дней с RVI>35                      │
    # └──────────────────────────────────────────────────────────────────────┘
    
    # 🔑 БАЗОВЫЕ ОКНА АНАЛИЗА
    'base_lookback': 20,              # Баланс между реакцией и шумом для момента
                                      # 20 дней = 1 месяц → оптимально для MOEX
    
    'base_vol_window': 10,            # 🔑 Волатильность АКТИВОВ на 10 дней
                                      # Короткое окно для быстрой реакции на изменение
                                      # волатильности отдельных инструментов (OBLG, GOLD)
    
    'market_vol_window': 21,          # 🔑 Волатильность РЫНКА на 21 день (ровно 1 месяц)
                                      # Длинное окно для стабильной оценки рыночного стресса
                                      # КРИТИЧЕСКИ: отличается от base_vol_window!
    
    # 🔑 ПОРОГИ ВОЛАТИЛЬНОСТИ (ГОДОВЫЕ ЗНАЧЕНИЯ!)
    'max_vol_threshold': 0.60,        # 40% годовой волатильности для активов
                                      # Выше для высоковолатильных активов MOEX (OBLG, GOLD)
                                      # Блокирует только экстремальные периоды (>40%)
    
    'market_vol_threshold': 0.35,    # 🔑 3.5% годовой волатильности как порог блокировки
                                      # Срабатывает только при реальном стрессе рынка
                                      # (годовая волатильность IMOEX > 35%)
    
    'risk_free_ticker': 'LQDT',       # Денежный рынок как кэш при стрессе
    
    # Включаем все параметры стратегии из блока выше (RVI thresholds, адаптация и т.д.)
    **dual_momentum_strategy_params,
}

# ======================
# БЫСТРАЯ ОПТИМИЗАЦИЯ — Для тестирования и отладки (≈60 комбинаций)
# ======================
quick_optimization_grid = {
    # Минимальный набор для проверки работоспособности с корректными окнами
    'base_lookback': [20],
    'base_vol_window': [10],          # 🔑 Короткое окно для активов
    'market_vol_window': [21],        # 🔑 Длинное окно для рынка (КРИТИЧЕСКИ ОТЛИЧНОЕ!)
    'max_vol_threshold': [0.40],
    'market_vol_threshold': [0.035],  # 🔑 Реалистичный порог для MOEX
    'use_rvi_adaptation': [True],
    'rvi_high_exit_threshold': [35],
    'rvi_low_threshold': [15],
    'rvi_medium_threshold': [25],
    'rvi_low_multiplier': [1.2],
    'rvi_high_multiplier': [0.7],
    'trend_filter_on_insufficient_data': ['allow'],
    'use_trend_filter': [True],
    'trend_window': [60],
    'bare_mode': [False],
    'risk_free_ticker': ['LQDT']
}

# ======================
# НАСТРОЙКИ ОПТИМИЗАЦИИ — Поведение алгоритма поиска
# ======================
optimization_settings = {
    'n_iter': 500,                   # Макс. итераций для RandomizedSearchCV
    'cv_folds': 3,                   # Количество фолдов для кросс-валидации (если используется)
    'scoring_metric': 'sharpe_ratio', # Метрика для выбора лучшей модели
    'random_state': 42,              # Для воспроизводимости случайного поиска
    'max_runtime_hours': 1.0,        # Жёсткое ограничение по времени (1 час)
    'use_random_search': True        # Использовать RandomizedSearch вместо GridSearch
}

# ======================
# ИЗДЕРЖКИ ТОРГОВЛИ — Группировка для удобства передачи в Backtester
# ======================
trading_costs = {
    'commission_rate': commission_rate,
    'default_commission': default_commission,
    'slippage': slippage,
    'default_slippage': default_slippage,
    'use_slippage': use_slippage
}

# ======================
# МЕТАДАННЫЕ КОНФИГУРАЦИИ
# ======================
config_version = '2.5.0'
last_updated = '2026-02-01'
architecture_fix = 'market_vol_window_separation'  # Критическое исправление: разделение окон волатильности

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ КРИТИЧЕСКОЕ ПРЕДУПРЕЖДЕНИЕ ДЛЯ РАЗРАБОТЧИКОВ                            │
# └──────────────────────────────────────────────────────────────────────────┘
critical_warning = (
    "ВНИМАНИЕ: market_vol_window ДОЛЖЕН отличаться от base_vol_window. "
    "Использование одинаковых окон приводит к деградации рыночного фильтра "
    "и некорректной работе параметра market_vol_threshold на высоковолатильном рынке MOEX. "
    "Рекомендуемые значения: base_vol_window=10, market_vol_window=21."
)

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ ПРАКТИЧЕСКИЕ РЕКОМЕНДАЦИИ ДЛЯ РЕАЛЬНОЙ ТОРГОВЛИ НА МОEX                 │
# └──────────────────────────────────────────────────────────────────────────┘
trading_recommendations = """
РЕКОМЕНДАЦИИ ДЛЯ ПРОДАКШН-ТОРГОВЛИ НА МОСБИРЖЕ:

1. МОНИТОРИНГ RVI В РЕАЛЬНОМ ВРЕМЕНИ:
   • При приближении RVI к 30 — подготовиться к выходу в кэш
   • При RVI ≥ 35 — немедленно перейти в LQDT (денежный рынок)
   • После падения RVI ниже 25 — можно возвращаться в рисковые активы

2. АДАПТАЦИЯ ПОРОГОВ ПОД ТЕКУЩИЙ РЕЖИМ:
   • Нормальный режим (RVI 15-25): использовать базовые параметры
   • Повышенный стресс (RVI 25-35): снизить market_vol_threshold до 0.030
   • Экстремальный стресс (RVI > 35): перейти в кэш, не дожидаясь волатильности

3. СПЕЦИФИКА АКТИВОВ MOEX:
   • OBLG: наиболее стабильный актив, но чувствителен к решениям ЦБ
   • GOLD: защитный актив при геополитической нестабильности
   • EQMX: высокая доходность, но максимальная волатильность
   • LQDT: кэш при стрессе, минимальная доходность в норме

4. ВРЕМЯ ТОРГОВЛИ:
   • Избегать первых 30 минут сессии (10:00-10:30) — высокая волатильность
   • Оптимальное время ребалансировки: 11:00-12:00 или 15:00-16:00
   • Избегать последних 30 минут (18:10-18:40) — закрытие позиций институционалов

5. УПРАВЛЕНИЕ РИСКАМИ:
   • Макс. размер позиции: 33% от портфеля на один актив
   • Stop-loss не используется (стратегия на основе фильтров)
   • При двух последовательных убытках подряд — снизить размер позиции на 50%
"""