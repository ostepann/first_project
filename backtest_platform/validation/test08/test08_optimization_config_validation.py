# backtest_platform/validation/test08/test08_optimization_config_validation.py

"""
Конфигурация Теста 8: Валидация метрик бэктеста (CAGR, Sharpe, MaxDD)

ОСОБЕННОСТИ ДИЗАЙНА:
-------------------
1. 5 торговых дней вместо 4:
   • Дни 1-2: прогревочный период (цена 100.0)
   • День 2: покупка по целевой цене 100.0 благодаря достаточному хистори для моментума
   • Дни 3-5: рост для формирования ненулевой волатильности

2. base_lookback=2:
   • Минимальное окно для расчёта моментума
   • Гарантирует покупку на День 2 по цене 100.0 (а не 101.0 как в предыдущей версии)

3. Ожидаемые метрики рассчитаны для кривой:
   [100_000, 100_000, 101_000, 101_500, 102_500]
   
   Детали расчёта:
   • Дневные доходности:
        r1 = (100_000 - 100_000) / 100_000 = 0.000000
        r2 = (101_000 - 100_000) / 100_000 = 0.010000
        r3 = (101_500 - 101_000) / 101_000 = 0.004950495
        r4 = (102_500 - 101_500) / 101_500 = 0.009852217
   
   • CAGR = (102_500 / 100_000) ^ (252 / 5) - 1
          = 1.025 ^ 50.4 - 1
          = 2.5247 (252.47% годовых)
   
   • Sharpe = (mean(r) * 252) / (std(r, ddof=1) * sqrt(252))
          mean(r) = (0 + 0.01 + 0.004950495 + 0.009852217) / 4 = 0.006200678
          std(r)  = 0.004531 (выборочное отклонение, ddof=1)
          Sharpe  = (0.006200678 * 252) / (0.004531 * sqrt(252))
                  = 21.732
   
   • MaxDD = 0.0 (монотонный рост после покупки)
"""

# === 1. ПУТИ И БАЗОВЫЕ НАСТРОЙКИ ===
data_dir = 'data-validation/test08'
assets = ['EQMX', 'LQDT']
risk_free_ticker = 'LQDT'

# === 2. ПАРАМЕТРЫ СТРАТЕГИИ ===
# Гарантируют детерминированный выбор EQMX на второй торговый день:
#   • base_lookback=2: минимальное окно для расчёта моментума
#   • bare_mode=True: отключаем все фильтры (тренд, волатильность, RVI)
#   • На День 2: моментум EQMX = 0% > -1e10 → выбор активов происходит корректно
strategy_params = {
    'base_lookback': 2,           # Критически важно: 2 дня для расчёта моментума
    'bare_mode': True,            # Только чистый моментум
    'max_vol_threshold': 1.0,     # Отключаем фильтр волатильности
    'risk_free_ticker': 'LQDT'
}

# === 3. ОЖИДАЕМЫЕ МЕТРИКИ ===
# Рассчитаны для кривой капитала: [100_000, 100_000, 101_000, 101_500, 102_500]
# Формулы соответствуют реализации в backtest_platform/core/backtester.py
expected_metrics = {
    'cagr': 2.5247,      # 252.47% годовых
    'sharpe': 21.732,    # Стабильный рост + ненулевая волатильность
    'max_drawdown': 0.0  # Монотонный рост после покупки
}

# === 4. ДОПУСКИ ДЛЯ СРАВНЕНИЯ ===
# Относительный допуск 0.1% учитывает погрешность float64
tolerance = 0.001  # 0.1%

# Абсолютный допуск для MaxDD (должен быть точно 0.0)
maxdd_tolerance = 1e-6