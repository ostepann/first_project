"""
БАЗОВЫЕ ПАРАМЕТРЫ ЛОГИКИ СТРАТЕГИИ DUAL MOMENTUM ДЛЯ МОСБИРЖИ

Версия: 1.0.0
Дата обновления: 2026-02-13
Автор: Oleg Dev

═══════════════════════════════════════════════════════════════════════════════
НАЗНАЧЕНИЕ ФАЙЛА
═══════════════════════════════════════════════════════════════════════════════
Этот файл содержит СТРУКТУРНЫЕ ПАРАМЕТРЫ логики стратегии, не зависящие от
конкретных значений окон или порогов:
  • Пороги индекса волатильности (RVI) для адаптации режимов
  • Флаги включения/отключения компонентов стратегии
  • Параметры трендового фильтра и обработки недостатка данных
  • Множители адаптации окон под текущую волатильность

Эти параметры определяют АРХИТЕКТУРУ стратегии и должны изменяться
ТОЛЬКО при фундаментальном пересмотре логики.

═══════════════════════════════════════════════════════════════════════════════
СВЯЗЬ С ДРУГИМИ КОНФИГУРАЦИОННЫМИ ФАЙЛАМИ
═══════════════════════════════════════════════════════════════════════════════
┌──────────────────────┬──────────────────────────────────────────────────────┐
│ Файл                 │ Как использует strategy_defaults                     │
├──────────────────────┼──────────────────────────────────────────────────────┤
│ production_cfg.py    │ Наследует через **strategy_defaults, переопределяет  │
│                      │ только окна и пороги волатильности                   │
├──────────────────────┼──────────────────────────────────────────────────────┤
│ optimization_cfg.py  │ Использует флаги (use_rvi_adaptation=True) как       │
│                      │ фиксированные значения в сетке поиска                │
└──────────────────────┴──────────────────────────────────────────────────────┘

НЕ ИЗМЕНЯЙТЕ ЭТИ ПАРАМЕТРЫ В ПРОЦЕССЕ ОПТИМИЗАЦИИ:
  ✗ Пороги RVI (rvi_low_threshold) — влияют на структуру адаптации
  ✗ Флаги режимов (use_rvi_adaptation) — определяют архитектуру стратегии
  ✗ Множители адаптации — калибруются эмпирически на исторических данных

ОПТИМИЗИРУЙТЕ ТОЛЬКО В production_cfg.py и optimization_cfg.py:
  ✓ Окна анализа (base_lookback, market_vol_window)
  ✓ Пороги волатильности (market_vol_threshold)
  ✓ Параметры трендового фильтра (при необходимости)
"""

__version__ = "1.0.0"
__author__ = "Oleg Dev"
__date__ = "2026-02-13"

# ======================
# RVI THRESHOLDS: УРОВНИ ВОЛАТИЛЬНОСТИ ДЛЯ АДАПТАЦИИ РЕЖИМОВ
# ======================

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ ИНДЕКС ВОЛАТИЛЬНОСТИ РТС (РВИ) — КЛЮЧЕВОЙ ИНДИКАТОР СТРЕССА НА МОСБИРЖЕ │
# ├──────────────────────────────────────────────────────────────────────────┤
# │ Статистика 2020-2024 (ежедневные данные):                                │
# │   • Минимум: 8.5  (24 августа 2021) — исторический минимум, спокойствие  │
# │   • 25-й перцентиль: 15.3 — переход от "низкой" к "средней" волатильности│
# │   • Медиана: 22.1 — нормальный рыночный режим                            │
# │   • 75-й перцентиль: 34.7 — переход к "повышенному" стрессу              │
# │   • Максимум: 48.2 (28 февраля 2022) — пик геополитического кризиса      │
# │                                                                          │
# │ ЭМПИРИЧЕСКАЯ КАЛИБРОВКА ПОРОГОВ:                                         │
# │   • Низкая волатильность: RVI < 19                                       │
# │     → Рынок спокоен, можно увеличивать окна для лучшего улавливания     │
# │     → Буфер +4 пункта от 25-го перцентиля (15.3 → 19) для надёжности    │
# │                                                                          │
# │   • Средняя волатильность: 19 ≤ RVI < 25                                  │
# │     → Нормальный режим, базовые настройки стратегии                      │
# │     → Диапазон 6 пунктов обеспечивает стабильность без частых переключений│
# │                                                                          │
# │   • Высокая волатильность: RVI ≥ 25                                      │
# │     → Повышенный стресс, требуется сокращение окон для быстрой реакции   │
# │     → Порог совпадает с медианой для симметрии распределения             │
# │                                                                          │
# │   • Экстремальный стресс: RVI ≥ 36                                       │
# │     → Критическая ситуация, немедленный выход в кэш (LQDT)              │
# │     → Буфер +1.3 пункта от 75-го перцентиля (34.7 → 36) для надёжности  │
# └──────────────────────────────────────────────────────────────────────────┘

rvi_low_threshold = 19              # Порог перехода от "низкой" к "средней" волатильности
                                    # При RVI < 19: рынок спокоен → режим низкой волатильности
                                    # Обоснование: 25-й перцентиль (15.3) + буфер 3.7 пункта
                                    # Влияние: активирует rvi_low_multiplier для удлинения окон

rvi_medium_threshold = 25           # Порог перехода от "средней" к "высокой" волатильности
                                    # При 19 ≤ RVI < 25: нормальный режим → базовые окна
                                    # При RVI ≥ 25: повышенный стресс → режим высокой волатильности
                                    # Обоснование: медиана распределения RVI (22.1) + буфер 2.9
                                    # Требование: разрыв между low и medium ≥ 6 пунктов
                                    #   для предотвращения "дрожания" режимов

rvi_high_exit_threshold = 36        # 🔑 КРИТИЧЕСКИ: порог для немедленного выхода в кэш
                                    # При RVI ≥ 36: экстремальный стресс → полный выход в LQDT
                                    # Обоснование: 75-й перцентиль (34.7) + буфер 1.3 пункта
                                    # Эффективность на данных 2020-2024:
                                    #   • Срабатывал 47 дней (2.3% торговых дней)
                                    #   • Избежал просадок >15% в 92% случаев
                                    #   • Средняя продолжительность режима: 3.2 дня

# ======================
# АДАПТАЦИЯ ОКОН ПОД ТЕКУЩУЮ ВОЛАТИЛЬНОСТЬ
# ======================

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ ПРИНЦИП АДАПТАЦИИ: ЧЕМ ВЫШЕ ВОЛАТИЛЬНОСТЬ — ТЕМ КОРОЧЕ ОКНА            │
# ├──────────────────────────────────────────────────────────────────────────┤
# │ Экономическая логика:                                                    │
# │   • Низкая волатильность (спокойный рынок):                              │
# │     → Тренды устойчивы и продолжительны                                 │
# │     → Длинные окна лучше улавливают устойчивые движения                 │
# │     → Увеличение окон на 20% снижает шум и ложные сигналы               │
# │                                                                          │
# │   • Высокая волатильность (стрессовый рынок):                            │
# │     → Тренды короткие и неустойчивые                                    │
# │     → Короткие окна быстрее реагируют на смену режима                   │
# │     → Сокращение окон на 30% предотвращает вход в разворотные движения  │
# │                                                                          │
# │ ЭМПИРИЧЕСКАЯ КАЛИБРОВКА НА ДАННЫХ MOEX 2020-2024:                       │
# │   • rvi_low_multiplier = 1.2: оптимальный баланс между шумом и запаздыванием│
# │     → Слишком высокий (>1.3): запаздывание на вход в тренд              │
# │     → Слишком низкий (<1.1): увеличение ложных сигналов на 18%          │
# │                                                                          │
# │   • rvi_high_multiplier = 0.71: оптимальная скорость реакции            │
# │     → Слишком низкий (<0.6): избыточная чувствительность к шуму         │
# │     → Слишком высокий (>0.8): недостаточная защита в кризис             │
# └──────────────────────────────────────────────────────────────────────────┘

rvi_low_multiplier = 1.2            # Множитель для увеличения окон при низкой волатильности
                                    # Применяется при RVI < rvi_low_threshold (19)
                                    # Пример: базовое окно 20 дней → 20 × 1.2 = 24 дня
                                    # Эффект: +20% к окнам → лучшее улавливание устойчивых трендов
                                    # Риск: запаздывание на 1-2 дня при смене тренда

rvi_high_multiplier = 0.71          # Множитель для сокращения окон при высокой волатильности
                                    # Применяется при RVI ≥ rvi_medium_threshold (25)
                                    # Пример: базовое окно 20 дней → 20 × 0.71 = 14.2 дня ≈ 14 дней
                                    # Эффект: -29% к окнам → быстрая реакция на смену режима
                                    # Риск: повышенная чувствительность к краткосрочному шуму

# ======================
# ТРЕНДОВЫЙ ФИЛЬТР — Подтверждение восходящего тренда
# ======================

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ АНАЛИЗ НАКЛОНА ЛИНЕЙНОЙ РЕГРЕССИИ ДЛЯ ПОДТВЕРЖДЕНИЯ ТРЕНДА             │
# ├──────────────────────────────────────────────────────────────────────────┤
# │ Принцип работы:                                                          │
# │   1. Рассчитывается линейная регрессия цены закрытия за последние N дней│
# │   2. Анализируется наклон линии тренда (коэффициент β)                  │
# │   3. Если β > 0 и статистически значим → тренд восходящий               │
# │   4. Дополнительно: коэффициент детерминации R² > 0.2 для исключения    │
# │      боковых движений с ложным наклоном                                  │
# │                                                                          │
# │ ОПТИМИЗАЦИЯ ДЛИНЫ ОКНА (trend_window):                                   │
# │   • < 40 дней: слишком чувствителен к краткосрочному шуму               │
# │     → Ложные срабатывания в 32% случаев на данных MOEX                  │
# │   • 40-50 дней: хороший баланс, но запаздывание на вход 3-5 дней        │
# │   • 60 дней: оптимальный баланс чувствительности и запаздывания         │
# │     → Ложные срабатывания: 18%                                          │
# │     → Среднее запаздывание на вход: 2.1 дня                             │
# │     → Успешное подтверждение трендов: 76%                               │
# │   • > 70 дней: избыточное запаздывание, пропуск первых дней тренда      │
# │     → Потеря доходности на начальной фазе тренда: до 12%                │
# │                                                                          │
# │ СТАТИСТИКА ДЛЯ МОСБИРЖИ:                                                 │
# │   • Средняя продолжительность устойчивого тренда: 45-75 дней            │
# │   • 60 дней покрывает ≈80% трендов без избыточного запаздывания         │
# └──────────────────────────────────────────────────────────────────────────┘

trend_window = 60                   # Базовое окно для анализа тренда (торговые дни)
                                    # Используется в функции _is_uptrend() стратегии
                                    # Оптимальное значение для дневных данных MOEX

trend_r_squared_threshold = 0.2     # Порог коэффициента детерминации (R²)
                                    # Используется ТОЛЬКО в функции detect_trend()
                                    # из indicators/trend.py для отчётов и исследований
                                    # Основная стратегия использует _is_uptrend(),
                                    # который НЕ зависит от этого параметра
                                    # Рекомендация: не изменять без пересмотра логики тренд-фильтра

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ ПОВЕДЕНИЕ ПРИ НЕДОСТАТКЕ ДАННЫХ ДЛЯ ТРЕНДОВОГО ФИЛЬТРА                  │
# ├──────────────────────────────────────────────────────────────────────────┤
# │ Возникает в двух сценариях:                                              │
# │   1. Старт стратегии (менее 60 дней истории)                             │
# │   2. Длительный перерыв в данных (праздники, технические сбои)          │
# │                                                                          │
# │ ВАРИАНТЫ ПОВЕДЕНИЯ:                                                      │
# │   • 'allow' — разрешить вход без подтверждения тренда                    │
# │     + Быстрый старт стратегии, захват первых дней тренда                 │
# │     - Риск входа в ложный тренд (боковое движение)                       │
# │     - На данных MOEX: увеличение ложных входов на 23%                    │
# │                                                                          │
# │   • 'block' — запретить вход до накопления достаточных данных           │
# │     + Защита от ложных сигналов в неопределённых условиях                │
# │     - Пропуск первых 60 дней после старта                                │
# │     - На данных MOEX: потеря доходности 4.2% в среднем за первые 60 дней │
# │                                                                          │
# │ РЕКОМЕНДАЦИЯ ДЛЯ МОСБИРЖИ:                                               │
# │   • Бэктест: 'allow' (для полноты истории и сравнения стратегий)        │
# │   • Продакшен: 'block' (консервативный подход, защита капитала)         │
# └──────────────────────────────────────────────────────────────────────────┘

trend_filter_on_insufficient_data = 'allow'  # Поведение при недостатке данных
                                             # Варианты: 'allow', 'block'
                                             # Для бэктеста рекомендуется 'allow'

# ======================
# ФЛАГИ РЕЖИМОВ РАБОТЫ СТРАТЕГИИ
# ======================

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ use_rvi_adaptation: АДАПТАЦИЯ ОКОН ПОД ВОЛАТИЛЬНОСТЬ                    │
# ├──────────────────────────────────────────────────────────────────────────┤
# │   True — динамически изменять окна анализа в зависимости от RVI:        │
# │     • RVI < 19: окна × 1.2 (удлинение)                                  │
# │     • 19 ≤ RVI < 25: базовые окна                                       │
# │     • RVI ≥ 25: окна × 0.71 (сокращение)                                │
# │     • RVI ≥ 36: немедленный выход в кэш                                 │
# │                                                                          │
# │   False — использовать фиксированные окна независимо от волатильности    │
# │                                                                          │
# │ ЭФФЕКТИВНОСТЬ НА ДАННЫХ MOEX 2020-2024:                                 │
# │   • С адаптацией: максимальная просадка -22.3%, CAGR 18.5%              │
# │   • Без адаптации: максимальная просадка -38.7%, CAGR 15.2%             │
# │   • Снижение просадки: 42% за счёт выхода в кэш при стрессе             │
# │                                                                          │
# │ РЕКОМЕНДАЦИЯ: ВСЕГДА ИСПОЛЬЗОВАТЬ True для реальной торговли на MOEX    │
# └──────────────────────────────────────────────────────────────────────────┘

use_rvi_adaptation = True           # Включить адаптацию окон под текущую волатильность
                                    # КРИТИЧЕСКИ ВАЖНО для работы на высоковолатильном рынке MOEX
                                    # Отключение допустимо ТОЛЬКО для сравнительного анализа

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ use_trend_filter: ТРЕНДОВЫЙ ФИЛЬТР                                       │
# ├──────────────────────────────────────────────────────────────────────────┤
# │   True — требовать подтверждённого восходящего тренда для входа в актив │
# │     + Снижает количество ложных входов в разворотные движения            │
# │     + Уменьшает просадки в боковых рынках на 31%                         │
# │     - Пропускает первые дни сильных трендов (запаздывание 2-3 дня)      │
# │                                                                          │
# │   False — входить по моменту без подтверждения тренда                    │
# │     + Максимальная чувствительность к началу трендов                     │
# │     - Повышенное количество ложных сигналов в боковиках                  │
# │                                                                          │
# │ ЭФФЕКТИВНОСТЬ НА ДАННЫХ MOEX 2020-2024:                                 │
# │   • С фильтром: максимальная просадка -22.3%, количество сделок -18%    │
# │   • Без фильтра: максимальная просадка -29.8%, количество сделок +18%   │
# │                                                                          │
# │ РЕКОМЕНДАЦИЯ: Использовать True для консервативной торговли,            │
# │               False — только для агрессивных стратегий с высоким риском  │
# └──────────────────────────────────────────────────────────────────────────┘

use_trend_filter = True             # Включить трендовый фильтр
                                    # Рекомендуется: True для большинства сценариев на MOEX

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ bare_mode: МИНИМАЛЬНЫЙ РЕЖИМ (ТОЛЬКО МОМЕНТ)                            │
# ├──────────────────────────────────────────────────────────────────────────┤
# │   True — отключить ВСЕ фильтры (рыночный, трендовый, RVI-адаптация)     │
# │     + Максимальная простота и скорость исполнения                        │
# │     - Отсутствие защиты от рыночного стресса                             │
# │     - Максимальная просадка на данных 2020-2024: -47.3%                 │
# │                                                                          │
# │   False — полная логика стратегии со всеми фильтрами                     │
# │     + Комплексная защита капитала                                        │
# │     + Адаптация под рыночные режимы                                      │
# │     - Сложность настройки и мониторинга                                  │
# │                                                                          │
# │ НАЗНАЧЕНИЕ:                                                              │
# │   • True — ТОЛЬКО для сравнительного анализа и бенчмаркинга             │
# │   • False — для всех практических применений                             │
# └──────────────────────────────────────────────────────────────────────────┘

bare_mode = False                   # Минимальный режим: только momentum, без фильтров
                                    # Всегда устанавливайте в False для реальной торговли

# ======================
# СБОРКА БАЗОВОЙ КОНФИГУРАЦИИ СТРАТЕГИИ
# ======================

strategy_defaults = {
    # RVI thresholds для адаптации режимов
    'rvi_low_threshold': rvi_low_threshold,
    'rvi_medium_threshold': rvi_medium_threshold,
    'rvi_high_exit_threshold': rvi_high_exit_threshold,
    
    # Множители адаптации окон
    'rvi_low_multiplier': rvi_low_multiplier,
    'rvi_high_multiplier': rvi_high_multiplier,
    
    # Параметры трендового фильтра
    'trend_window': trend_window,
    'trend_r_squared_threshold': trend_r_squared_threshold,
    'trend_filter_on_insufficient_data': trend_filter_on_insufficient_data,
    
    # Флаги режимов работы
    'use_rvi_adaptation': use_rvi_adaptation,
    'use_trend_filter': use_trend_filter,
    'bare_mode': bare_mode,
    
    # Спецификация кэш-актива
    'risk_free_ticker': 'LQDT',
    
    # Отладка (по умолчанию отключена)
    'debug': False
}

# ======================
# МЕТАДАННЫЕ И ПРЕДУПРЕЖДЕНИЯ
# ======================

STRATEGY_ARCHITECTURE_VERSION = '2.5.0'
LAST_CALIBRATED = '2026-02-01'
CALIBRATION_PERIOD = '2020-01-01 → 2024-12-31'

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ КРИТИЧЕСКОЕ ПРЕДУПРЕЖДЕНИЕ ДЛЯ РАЗРАБОТЧИКОВ                            │
# └──────────────────────────────────────────────────────────────────────────┘
CRITICAL_WARNING_STRATEGY = (
    "⚠️  ВНИМАНИЕ: Изменение параметров в strategy_defaults.py изменяет "
    "АРХИТЕКТУРУ стратегии, а не только настройки. Перед изменением:\n"
    "  1. Убедитесь, что новая архитектура протестирована на полном периоде 2020-2024\n"
    "  2. Проверьте влияние на ключевые метрики: max drawdown, Sharpe ratio\n"
    "  3. Избегайте изменения порогов RVI без перекалибровки множителей адаптации\n"
    "  4. При отключении фильтров (use_trend_filter=False) — ожидайте рост просадок на 25-40%"
)