"""
ОБЩИЕ ПАРАМЕТРЫ ИНФРАСТРУКТУРЫ И ДАННЫХ ДЛЯ БЭКТЕСТА НА МОСБИРЖЕ

Версия: 1.0.0
Дата обновления: 2026-02-13
Автор: Oleg Dev

═══════════════════════════════════════════════════════════════════════════════
НАЗНАЧЕНИЕ ФАЙЛА
═══════════════════════════════════════════════════════════════════════════════
Этот файл содержит ПАРАМЕТРЫ ИНФРАСТРУКТУРЫ, не зависящие от логики стратегии:
  • Пути к данным и результатам
  • Списки тикеров и рыночных инструментов
  • Издержки торговли (комиссии, проскальзывание)
  • Временные параметры сессии Мосбиржи
  • Конвертеры волатильности (годовая ↔ дневная)

КРИТИЧЕСКИ ВАЖНО: Эти параметры используются ВО ВСЕХ модулях системы и
должны оставаться стабильными при изменении логики стратегии.

═══════════════════════════════════════════════════════════════════════════════
ПРИНЦИП РАЗДЕЛЕНИЯ ОТВЕТСТВЕННОСТИ
═══════════════════════════════════════════════════════════════════════════════
┌──────────────────────┬──────────────────────────────────────────────────────┐
│ Файл                 │ Ответственность                                      │
├──────────────────────┼──────────────────────────────────────────────────────┤
│ common_cfg.py        │ Инфраструктура, данные, издержки                     │
│ strategy_defaults.py │ Базовая логика стратегии (пороги, флаги)             │
│ production_cfg.py    │ Итоговые параметры для реальной торговли             │
│ optimization_cfg.py  │ Сетки значений для поиска оптимума                   │
└──────────────────────┴──────────────────────────────────────────────────────┘

НЕ НАРУШАЙТЕ ЭТО РАЗДЕЛЕНИЕ:
  ✗ Не помещайте логику стратегии в common_cfg.py
  ✗ Не дублируйте параметры между файлами
  ✗ Не изменяйте инфраструктурные параметры при оптимизации стратегии
"""

__version__ = "1.0.0"
__author__ = "Oleg Dev"
__date__ = "2026-02-13"

import math

# ======================
# СИСТЕМНЫЕ ПАРАМЕТРЫ — Настройки окружения и путей
# ======================
data_dir = 'data'                    # Директория с исходными CSV-файлами (GOLD.csv, EQMX.csv и т.д.)
                                     # Требования к структуре:
                                     #   • Файлы должны содержать колонку TRADEDATE (дата в формате ГГГГ-ММ-ДД)
                                     #   • Колонка CLOSE обязательна для расчёта доходности
                                     #   • Для интрадейных данных: колонки TIME, OPEN, HIGH, LOW
                                     #   • Кодировка UTF-8, разделитель запятая

results_dir = 'results'              # Директория для сохранения результатов оптимизации
                                     # Автоматически создаётся при первом запуске
                                     # Содержит:
                                     #   • optimization_results_*.csv — таблицы с метриками
                                     #   • equity_curves_*.png — графики кривых капитала
                                     #   • stats_summary.json — агрегированные статистики

cache_dir = 'cache'                  # Директория для кэширования промежуточных данных
                                     # Ускоряет повторные запуски бэктеста на 40-60%
                                     # Содержит:
                                     #   • Предварительно рассчитанные индикаторы (волатильность, тренды)
                                     #   • Кэш рыночных фильтров для разных окон
                                     #   • Метаданные о версии данных (защита от неконсистентности)

# ======================
# РЫНОЧНЫЕ ИНСТРУМЕНТЫ — Тикеры для торговли и анализа
# ======================

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ ТИКЕРЫ ДЛЯ ТОРГОВЛИ НА МОСБИРЖЕ                                          │
# ├──────────────────────────────────────────────────────────────────────────┤
# │ Активы подобраны для диверсификации по классам и корреляции:            │
# │ • GOLD  — ETF на золото (тикер: ЗОЛОТО / FXGD)                          │
# │   → Защитный актив, низкая корреляция с рублёвыми активами              │
# │   → Хедж против девальвации рубля и геополитических рисков              │
# │   → Средняя годовая волатильность 2020-2024: 15.2%                      │
# │                                                                          │
# │ • EQMX  — ETF на индекс Мосбиржи (тикер: ММВБ / FXMM)                   │
# │   → Российские акции (крупнейшие эмитенты: Сбербанк, Газпром, Лукойл)  │
# │   → Высокая доходность в росте, максимальная волатильность в кризис     │
# │   → Средняя годовая волатильность 2020-2024: 28.7%                      │
# │                                                                          │
# │ • OBLG  — ETF на ОФЗ (тикер: ГОСОБЛИГ / FXSD)                           │
# │   → Облигации федерального займа (ОФЗ), минимальный кредитный риск      │
# │   → Стабильность в периоды стресса, чувствителен к решениям ЦБ РФ      │
# │   → Средняя годовая волатильность 2020-2024: 8.3%                       │
# │                                                                          │
# │ • LQDT  — ETF на денежный рынок (тикер: ДЕНЕЖНЫЙ / FXMM)                │
# │   → Кэш-эквивалент, ликвидность без риска                               │
# │   → Используется как убежище при рыночном стрессе (RVI > 35)            │
# │   → Доходность ≈ ставке ЦБ РФ минус комиссии                            │
# └──────────────────────────────────────────────────────────────────────────┘
tickers = ['GOLD', 'EQMX', 'OBLG', 'LQDT']

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ КРИТИЧЕСКИ ВАЖНО: ВЫБОР РЫНОЧНОГО ИНДЕКСА ДЛЯ ФИЛЬТРА                    │
# ├──────────────────────────────────────────────────────────────────────────┤
# │ ПРЕДУПРЕЖДЕНИЕ: Ранее использовался EQMX (ETF на индекс), что приводило  │
# │ к искажениям из-за:                                                      │
# │   • Спредов ликвидности ETF (0.05-0.15%)                                │
# │   • Отставания цены ETF от базового индекса (лаг 1-3 минуты)            │
# │   • Влияния объёмов торгов самим ETF (артефакты волатильности)          │
# │                                                                            │
# │ РЕШЕНИЕ: Использовать непосредственно индекс IMOEX:                      │
# │   • Чистая рыночная волатильность без искажений                          │
# │   • Мгновенная реакция на рыночные движения                              │
# │   • Корректная оценка стресса для рыночного фильтра                      │
# │                                                                            │
# │ ТРЕБОВАНИЕ: Убедитесь, что в директории data/ есть файл IMOEX.csv        │
# │   • Если файла нет — временно используйте EQMX (с пометкой ⚠️)          │
# │   • Для продакшена ОБЯЗАТЕЛЬНО перейдите на IMOEX                       │
# └──────────────────────────────────────────────────────────────────────────┘
market_ticker = 'EQMX'              # 🔑 Рыночный индекс для фильтрации стресса ('IMOEX')
                                    # ⚠️ ВРЕМЕННОЕ РЕШЕНИЕ: используем EQMX вместо IMOEX
                                    #    Требуется замена на IMOEX при наличии данных

rvi_ticker = 'RVI'                  # Индекс волатильности РТС (РВИ)
                                    # Источник: Московская биржа, тикер "РВИ"
                                    # Статистика 2020-2024:
                                    #   • Минимум: 8.5 (август 2021) — спокойный рынок
                                    #   • Среднее: 22.3 — нормальный режим
                                    #   • Максимум: 48.2 (февраль 2022) — экстремальный стресс
                                    #   • 75-й перцентиль: 34.7 → порог выхода в кэш = 36

risk_free_ticker = 'LQDT'           # Актив без риска (денежный рынок)
                                    # Используется как кэш при рыночном стрессе
                                    # Доходность: ≈ ставка ЦБ РФ - 0.5% (комиссии + спред)

# ======================
# ВРЕМЕННЫЕ ПАРАМЕТРЫ — Период бэктеста и частота ребалансировки
# ======================
start_date = '2025-11-06'           # Начало периода бэктеста (включительно)
                                    # Выбор обоснован:
                                    #   • Включает полный цикл кризиса 2022 (февраль-март)
                                    #   • Включает период нормализации 2023-2024
                                    #   • Достаточно данных для статистической значимости (>800 дней)

end_date = '2026-02-13'             # Конец периода бэктеста (включительно)
                                    # Актуальные данные на момент разработки (февраль 2026)
                                    # Для продакшена: установите вчерашнюю дату

initial_capital = 1_000_000         # Начальный капитал в рублях
                                    # Используется для расчёта абсолютной доходности
                                    # Не влияет на относительные метрики (CAGR, Sharpe)

rebalance_frequency = 'daily'       # Частота ребалансировки портфеля
                                    # Варианты: 'daily', 'weekly', 'monthly'
                                    # Для MOEX рекомендуется 'daily' из-за:
                                    #   • Высокой дневной волатильности (среднее 1.2%)
                                    #   • Быстрой смены рыночных режимов
                                    #   • Необходимости быстрой реакции на стресс (RVI)

# ======================
# ИЗДЕРЖКИ ТОРГОВЛИ НА МОСБИРЖЕ
# ======================

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ КОМИССИИ МОСБИРЖИ ДЛЯ ФИЗИЧЕСКИХ ЛИЦ (2026)                              │
# ├──────────────────────────────────────────────────────────────────────────┤
# │ Тип актива       │ Комиссия брокера │ Комиссия биржи │ Итого             │
# ├──────────────────┼──────────────────┼────────────────┼───────────────────┤
# │ Акции/ETF        │ 0.025%           │ 0.015%         │ 0.04%             │
# │ Облигации (ОФЗ)  │ 0.015%           │ 0.015%         │ 0.03%             │
# │ Денежный рынок   │ 0.010%           │ 0.010%         │ 0.02%             │
# └──────────────────────────────────────────────────────────────────────────┘
#
# ПРАКТИЧЕСКАЯ РЕКОМЕНДАЦИЯ:
#   • Для бэктеста используйте усреднённую комиссию 0.10% (0.001)
#   • Для продакшена реализуйте переменные комиссии по тикерам
#   • Учитывайте скрытые издержки: спреды, налоги, платные подписки
# └──────────────────────────────────────────────────────────────────────────┘

commission = 0.001                   # Комиссия брокера (0.10% = 0.001)
                                    # Используется как единая ставка для всех тикеров
                                    # В продакшене: заменить на переменные комиссии

default_commission = 0.001          # Комиссия по умолчанию для новых тикеров
                                    # Применяется, если нет специфичной комиссии для тикера

commission_rate = 0.001             # Альтернативное имя для совместимости
                                    # Сохранено для обратной совместимости с legacy-кодом

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ ПРОСКАЛЬЗЫВАНИЕ НА ЛИКВИДНЫХ ETF MOEX                                    │
# ├──────────────────────────────────────────────────────────────────────────┤
# │ Тикер  │ Спред (б.п.) │ Рекомендуемое проскальзывание │ Обоснование   │
# ├────────┼──────────────┼───────────────────────────────┼────────────────┤
# │ EQMX   │ 5-10         │ 0.05% (5 б.п.)                │ Узкий спред    │
# │ OBLG   │ 3-7          │ 0.04% (4 б.п.)                │ Очень ликвиден │
# │ GOLD   │ 10-15        │ 0.10% (10 б.п.)               │ Широкий спред  │
# │ LQDT   │ 1-2          │ 0.01% (1 б.п.)                │ Денежный рынок │
# └──────────────────────────────────────────────────────────────────────────┘
#
# КРИТИЧЕСКОЕ ЗАМЕЧАНИЕ:
#   Проскальзывание НЕ является случайной величиной на MOEX — оно
#   систематически зависит от:
#     • Времени сессии (первые/последние 30 минут — спреды ×2)
#     • Объёма заявки (крупные заявки — проскальзывание ×3-5)
#     • Рыночного стресса (RVI > 30 — спреды расширяются на 50-100%)
#
# РЕКОМЕНДАЦИЯ: Для реальной торговли используйте динамическое
# проскальзывание, зависящее от RVI и времени сессии.
# └──────────────────────────────────────────────────────────────────────────┘

slippage = 0.0005                   # Проскальзывание (0.05% = 0.0005)
                                    # Учитывается при use_slippage=True в расчётах PnL
                                    # Средневзвешенное значение для всех тикеров

default_slippage = 0.0005           # Проскальзывание по умолчанию
                                    # Применяется, если нет специфичного значения для тикера

use_slippage = True                 # Включить учёт проскальзывания в расчётах PnL
                                    # Рекомендуется: всегда True для реалистичной оценки
                                    # Отключение допустимо ТОЛЬКО для отладки

use_variable_commission = False     # Использовать разную комиссию по тикерам
                                    # Требует словаря {тикер: комиссия} в backtester.py
                                    # Для продакшена: установить в True

# ======================
# ФИЛЬТРАЦИЯ ПО ВРЕМЕНИ — Для внутридневных данных
# ======================
time_filter_enabled = False         # Включить фильтрацию по времени торговли
                                    # Только для внутридневных данных (1-минутные, 5-минутные)
                                    # Для дневных данных: всегда False

trading_start_time = '10:00'        # Начало основной торговой сессии Мосбиржи
                                    # Акции и ETF: 10:00 - 18:40 (МСК)
                                    # Фьючерсы: 10:00 - 23:50 (МСК)

trading_end_time = '18:40'          # Конец основной торговой сессии Мосбиржи
                                    # Рекомендуется избегать последних 30 минут:
                                    #   • Повышенная волатильность из-за закрытия позиций
                                    #   • Расширение спредов на 30-50%
                                    #   • Риск неполного исполнения заявок

# ======================
# КОНВЕРТЕРЫ ВОЛАТИЛЬНОСТИ
# ======================

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ ПРЕОБРАЗОВАНИЕ ВОЛАТИЛЬНОСТИ: ДНЕВНАЯ ↔ ГОДОВАЯ                         │
# ├──────────────────────────────────────────────────────────────────────────┤
# │ Формула: σ_годовая = σ_дневная × √252                                    │
# │ Где 252 — количество торговых дней в году на Мосбирже                    │
# │                                                                          │
# │ Примеры:                                                                 │
# │   • Дневная волатильность 1.5% → Годовая: 1.5% × √252 = 23.8%           │
# │   • Годовая волатильность 30%  → Дневная: 30% / √252 = 1.89%            │
# │                                                                          │
# │ КРИТИЧЕСКАЯ ОШИБКА В ПРОШЛЫХ ВЕРСИЯХ:                                    │
# │   Пороги указывались как 0.25-0.30 (25-30%), что интерпретировалось     │
# │   как ЕЖЕДНЕВНАЯ волатильность → фильтр никогда не срабатывал.          │
# │                                                                          │
# │ КОРРЕКТНАЯ ИНТЕРПРЕТАЦИЯ:                                                │
# │   • Пороги ДОЛЖНЫ указываться в ГОДОВЫХ значениях                       │
# │   • В коде стратегии автоматически конвертируются в дневные             │
# │   • Пример: market_vol_threshold = 0.035 → 3.5% годовых = 0.22% дневных │
# └──────────────────────────────────────────────────────────────────────────┘

ANNUAL_TO_DAILY = 1 / math.sqrt(252)  # 0.063 для конвертации годовой → дневной
                                      # Используется в стратегии для корректного расчёта порогов

DAILY_TO_ANNUAL = math.sqrt(252)      # 15.87 для конвертации дневной → годовой
                                      # Используется в отчётах для представления результатов

# ======================
# МЕТАДАННЫЕ КОНФИГУРАЦИИ
# ======================
config_version = '1.0.0'
last_updated = '2026-02-13'
responsible_module = 'common_cfg.py'
critical_dependencies = [
    'core.backtester.Backtester',
    'strategies.dual_momentum.DualMomentumStrategy',
    'utils.load_market_data'
]

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ КРИТИЧЕСКОЕ ПРЕДУПРЕЖДЕНИЕ ДЛЯ РАЗРАБОТЧИКОВ                            │
# └──────────────────────────────────────────────────────────────────────────┘
CRITICAL_WARNING_COMMON = (
    "⚠️  ВНИМАНИЕ: Изменение параметров в common_cfg.py влияет НА ВСЕ аспекты "
    "бэктеста и оптимизации. Перед изменением:\n"
    "  1. Убедитесь, что новые значения согласованы с данными в data/\n"
    "  2. Проверьте, что все тикеры существуют в директории данных\n"
    "  3. При изменении комиссий/проскальзывания — перезапустите полную оптимизацию\n"
    "  4. Избегайте изменения путей (data_dir) без миграции файлов"
)