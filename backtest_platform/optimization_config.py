# backtest_platform/optimization_config.py

"""
Конфигурация параметров для оптимизации стратегий бэктестинга.
Сетка оптимизирована для практического использования (≈1 440 комбинаций вместо 108 000).
Версия 2.3.0: полная декомпозиция всех параметров стратегии Dual Momentum.

АРХИТЕКТУРНЫЙ ПРИНЦИП:
Все параметры, влияющие на логику принятия решений, вынесены сюда.
Код стратегии (dual_momentum.py) не должен содержать "магических чисел".
"""

# ======================
# СИСТЕМНЫЕ ПАРАМЕТРЫ — Настройки окружения и данных
# ======================
data_dir = 'data'                    # Директория с исходными CSV-файлами (GOLD.csv, EQMX.csv и т.д.)
results_dir = 'results'              # Директория для сохранения результатов оптимизации
cache_dir = 'cache'                  # Директория для кэширования промежуточных данных (ускорение)
tickers = ['GOLD', 'EQMX', 'OBLG', 'LQDT']  # Торгуемые активы
market_ticker = 'EQMX'               # Рыночный индекс для фильтрации (анализ волатильности рынка)
rvi_ticker = 'RVI'                   # Индикатор рыночного риска (Russian Volatility Index)
start_date = '2020-01-01'            # Начало периода бэктеста (включительно)
end_date = '2024-12-31'              # Конец периода бэктеста (включительно)
initial_capital = 1_000_000          # Начальный капитал в рублях (для расчёта абсолютной доходности)

# Издержки торговли
commission = 0.001                   # Комиссия брокера (0.1% = 0.001). Используется как fallback.
default_commission = 0.001           # Комиссия по умолчанию, если нет данных по конкретному тикеру.
commission_rate = 0.001              # Альтернативное имя для совместимости.
slippage = 0.0005                    # Проскальзывание (0.05% = 0.0005). Учитывается при use_slippage=True.
default_slippage = 0.0005            # Проскальзывание по умолчанию.
use_slippage = True                  # Включить учёт проскальзывания в расчётах PnL.

# Режимы торговли
rebalance_frequency = 'daily'        # Частота ребалансировки портфеля ('daily', 'weekly' и т.д.)
risk_free_asset = 'LQDT'             # Актив без риска (денежный ETF). Используется как кэш.
risk_free_ticker = 'LQDT'            # Альтернативное имя для совместимости.
use_variable_commission = False      # Использовать разную комиссию по тикерам (требует словаря в backtester).

# Фильтрация по времени (для внутридневных данных)
time_filter_enabled = False          # Включить фильтрацию по времени торговли.
trading_start_time = '10:00'         # Начало торговой сессии (для MOEX).
trading_end_time = '18:40'           # Конец торговой сессии (для MOEX).

# ======================
# ПАРАМЕТРЫ СТРАТЕГИИ DUAL MOMENTUM — Полная декомпозиция логики
# ======================
dual_momentum_strategy_params = {
    # --- RVI thresholds: уровни волатильности ---
    # Значения основаны на исторической статистике RVI (MOEX):
    #   <15 — низкая волатильность (спокойный рынок),
    #   15–25 — средняя волатильность,
    #   >25 — высокая волатильность (стресс).
    'rvi_low_threshold': 15,          # Порог перехода от "низкой" к "средней" волатильности.
    'rvi_medium_threshold': 25,       # Порог перехода от "средней" к "высокой" волатильности.
    'rvi_high_exit_threshold': 35,    # Порог для выхода в кэш (защита от экстремального стресса).

    # --- Адаптация окон под текущую волатильность ---
    # При низкой волатильности окна увеличиваются (ловим долгосрочные тренды).
    # При высокой волатильности окна сокращаются (реагируем быстрее на изменения).
    'rvi_low_multiplier': 1.2,        # Множитель для увеличения окон при низкой волатильности.
    'rvi_high_multiplier': 0.7,       # Множитель для сокращения окон при высокой волатильности.

    # --- Трендовый фильтр ---
    # Анализ наклона линейной регрессии для подтверждения восходящего тренда.
    # Рекомендуется 60 дней для дневных данных (≈3 месяца).
    'trend_window': 60,

    # --- Флаги режимов работы ---
    'use_rvi_adaptation': True,       # Включить адаптацию окон под RVI.
    'use_trend_filter': True,         # Включить трендовый фильтр (только восходящие тренды).
    'bare_mode': False,               # Минимальный режим: только momentum, без фильтров.
}

# ======================
# ОПТИМИЗИРОВАННАЯ СЕТКА ПАРАМЕТРОВ — Для полного перебора или случайного поиска
# ======================
param_grid = {
    # Основные окна анализа
    'base_lookback': [20, 25, 30],                   # Окно для расчёта momentum (торговые дни)
    'base_vol_window': [15, 20],                     # Окно для расчёта волатильности актива
    'market_vol_window': [25, 30, 40],               # Окно для рыночной волатильности (длиннее!)

    # Пороги волатильности
    'max_vol_threshold': [0.15, 0.25, 0.35],         # Макс. допустимая волатильность актива
    'market_vol_threshold': [0.25, 0.30],            # Порог для выхода в кэш по рыночной воле

    # RVI-адаптация (обязательна для эффективной стратегии)
    'use_rvi_adaptation': [True],
    'rvi_high_exit_threshold': [30, 35],             # Порог для экстренного выхода в кэш

    # Пороги RVI (можно оптимизировать под текущий рынок)
    'rvi_low_threshold': [10, 15, 20],
    'rvi_medium_threshold': [20, 25, 30],

    # Коэффициенты адаптации (тонкая настройка реакции на волатильность)
    'rvi_low_multiplier': [1.1, 1.2, 1.3],
    'rvi_high_multiplier': [0.6, 0.7, 0.8],

    # Трендовый фильтр
    'use_trend_filter': [True, False],               # Включить/выключить фильтр
    'trend_window': [60],                            # Фиксировано: 60 дней оптимально

    # Режимы
    'bare_mode': [False],                            # Отключено: фильтры критичны для управления рисками
    'risk_free_ticker': ['LQDT']
}

# ======================
# ПРОИЗВОДСТВЕННЫЕ ПАРАМЕТРЫ — Рекомендуемые настройки для реальной торговли
# ======================
production_params = {
    'base_lookback': 25,              # Баланс между реакцией и шумом
    'base_vol_window': 15,            # Достаточно для стабильной оценки волатильности
    'market_vol_window': 30,          # Рынок требует более длинного окна
    'max_vol_threshold': 0.30,        # Исключает самые волатильные активы
    'market_vol_threshold': 0.30,     # Защита от рыночного стресса
    'risk_free_ticker': 'LQDT',
    **dual_momentum_strategy_params,  # Включаем все параметры стратегии из блока выше
}

# ======================
# БЫСТРАЯ ОПТИМИЗАЦИЯ — Для тестирования и отладки (≈60 комбинаций)
# ======================
quick_optimization_grid = {
    # Минимальный набор для проверки работоспособности
    'base_lookback': [20, 25],
    'base_vol_window': [15],
    'market_vol_window': [30],
    'max_vol_threshold': [0.30],
    'market_vol_threshold': [0.30],
    'use_rvi_adaptation': [True],
    'rvi_high_exit_threshold': [35],
    'rvi_low_threshold': [15],
    'rvi_medium_threshold': [25],
    'rvi_low_multiplier': [1.2],
    'rvi_high_multiplier': [0.7],
    'use_trend_filter': [True, False],  # Сравнение с/без фильтра
    'trend_window': [60],
    'bare_mode': [False],
    'risk_free_ticker': ['LQDT']
}

# ======================
# НАСТРОЙКИ ОПТИМИЗАЦИИ — Поведение алгоритма поиска
# ======================
optimization_settings = {
    'n_iter': 500,                   # Макс. итераций для RandomizedSearchCV
    'cv_folds': 3,                   # Количество фолдов для кросс-валидации (если используется)
    'scoring_metric': 'sharpe_ratio', # Метрика для выбора лучшей модели
    'random_state': 42,              # Для воспроизводимости случайного поиска
    'max_runtime_hours': 1.0,        # Жёсткое ограничение по времени (1 час)
    'use_random_search': True        # Использовать RandomizedSearch вместо GridSearch
}

# ======================
# ИЗДЕРЖКИ ТОРГОВЛИ — Группировка для удобства передачи в Backtester
# ======================
trading_costs = {
    'commission_rate': commission_rate,
    'default_commission': default_commission,
    'slippage': slippage,
    'default_slippage': default_slippage,
    'use_slippage': use_slippage
}

# ======================
# МЕТАДАННЫЕ КОНФИГУРАЦИИ
# ======================
config_version = '2.3.0'
last_updated = '2026-02-01'
architecture_fix = 'full_strategy_decomposition'  # Все параметры стратегии вынесены в конфиг