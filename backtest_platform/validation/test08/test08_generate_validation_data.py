# backtest_platform/validation/test08/test08_generate_validation_data.py

"""
Тест 8: Генерация тестовых данных для валидации метрик бэктеста (CAGR, Sharpe, MaxDD)

ПРОБЛЕМА ПРЕДЫДУЩЕЙ ВЕРСИИ:
---------------------------
При 4 днях данных и base_lookback=2:
  • День 1: недостаточно данных для расчёта моментума → стратегия остаётся в кэше (LQDT)
  • День 2: появляются данные для расчёта → покупка EQMX по цене 101.0 (а не 100.0!)
  • Итог: кривая капитала [100_000, 100_000, 100_495, 101_485] вместо ожидаемой [100_000, 101_000, 101_500, 102_500]

РЕШЕНИЕ:
--------
Генерируем 5 торговых дней с "прогревочным периодом":
  • Дни 1-2: цена 100.0 — обеспечивает достаточный хистори для расчёта моментума на День 2
  • День 2: моментум = (100.0 - 100.0) / 100.0 = 0% → стратегия выбирает EQMX (0% > -∞)
  • Покупка происходит по цене 100.0 → получаем 1_000 акций
  • Дни 3-5: цены растут до 101.0 → 101.5 → 102.5
  
Итоговая кривая капитала:
  [100_000, 100_000, 101_000, 101_500, 102_500]
  • День 1: 100_000 (в кэше, недостаточно данных для сигнала)
  • День 2: 100_000 (покупка EQMX по 100.0 → 1_000 акций × 100.0)
  • День 3: 101_000 (1_000 × 101.0)
  • День 4: 101_500 (1_000 × 101.5)
  • День 5: 102_500 (1_000 × 102.5)

Почему 5 дней, а не 4?
  • Минимум 2 дня для расчёта моментума (base_lookback=2)
  • +1 день для покупки по целевой цене 100.0
  • +2 дня для формирования ненулевой волатильности (для корректного Sharpe)
"""

import pandas as pd
import os
import sys
import numpy as np

def main():
    # === НАСТРОЙКА ПУТЕЙ ===
    _config_path = os.path.dirname(__file__)
    if _config_path not in sys.path:
        sys.path.insert(0, _config_path)
    
    import test08_optimization_config_validation as cfg

    # Построение пути к директории сохранения данных
    output_dir = os.path.join(
        os.path.dirname(os.path.dirname(os.path.dirname(os.path.dirname(__file__)))),
        cfg.data_dir
    )
    os.makedirs(output_dir, exist_ok=True)

    # === ГЕНЕРАЦИЯ ЦЕНОВЫХ ДАННЫХ ===
    # 5 торговых дней (понедельник-пятница) для корректной работы логики бэктестера
    dates = pd.date_range(start='2025-01-01', periods=5, freq='B')

    """
    ДЕТАЛЬНЫЙ РАСЧЁТ ЦЕН ДЛЯ ЦЕЛЕВОЙ КРИВОЙ КАПИТАЛА:
    -------------------------------------------------
    Начальный капитал: 100_000 руб.
    
    День 1 (2025-01-01):
      • Данные: только 1 день → недостаточно для base_lookback=2
      • Сигнал: остаёмся в кэше (LQDT)
      • Капитал: 100_000 руб. (всё в кэше)
      • Цена EQMX: 100.0 (прогрев)
    
    День 2 (2025-01-02):
      • Данные: 2 дня → достаточно для расчёта моментума
      • Моментум EQMX: (100.0 - 100.0) / 100.0 = 0.0%
      • Моментум LQDT: (100.0 - 100.0) / 100.0 = 0.0% (но LQDT пропускается в цикле)
      • Стратегия выбирает первый актив с моментумом > -1e10 → EQMX
      • Покупка: 100_000 / 100.0 = 1_000 акций
      • Капитал после покупки: 1_000 × 100.0 = 100_000 руб.
      • Цена EQMX: 100.0
    
    День 3 (2025-01-03):
      • Цена EQMX: 101.0
      • Капитал: 1_000 × 101.0 = 101_000 руб. (+1.0%)
    
    День 4 (2025-01-04):
      • Цена EQMX: 101.5
      • Капитал: 1_000 × 101.5 = 101_500 руб. (+0.495%)
    
    День 5 (2025-01-05):
      • Цена EQMX: 102.5
      • Капитал: 1_000 × 102.5 = 102_500 руб. (+0.985%)
    
    Итоговая кривая капитала: [100_000, 100_000, 101_000, 101_500, 102_500]
    """
    eqmx_prices = [100.0, 100.0, 101.0, 101.5, 102.5]
    eqmx_series = pd.Series(eqmx_prices, index=dates, name='CLOSE')

    # LQDT — константный актив (риск-фри). Цена не меняется → моментум = 0%.
    # При равенстве моментумов стратегия выбирает первый актив из цикла (EQMX).
    lqdt_prices = [100.0] * 5
    lqdt_series = pd.Series(lqdt_prices, index=dates, name='CLOSE')

    data = {
        'EQMX': eqmx_series,
        'LQDT': lqdt_series
    }

    # === СОХРАНЕНИЕ ДАННЫХ В CSV ===
    # Формат файла соответствует требованиям загрузчика проекта:
    #   - Колонка TRADEDATE (datetime) — обязательное требование для бэктестера
    #   - Колонка CLOSE — цены закрытия в верхнем регистре
    for ticker, series in data.items():
        df = series.to_frame()
        df.index.name = 'TRADEDATE'
        df = df.reset_index()
        df.to_csv(os.path.join(output_dir, f"{ticker}.csv"), index=False)

    # === ВЫВОД ИТОГОВ ===
    print(f"✅ Тестовые данные для Теста 8 сохранены в {output_dir}")
    print(f"   Период: {dates[0].date()} → {dates[-1].date()} ({len(dates)} торговых дней)")
    print(f"   EQMX цены: {eqmx_prices}")
    print(f"   LQDT цены: {lqdt_prices}")
    print(f"   Ожидаемая кривая капитала при начальном капитале 100_000:")
    print(f"     [100_000.00, 100_000.00, 101_000.00, 101_500.00, 102_500.00]")
    print(f"   Дневные доходности: [0.00%, +1.00%, +0.495%, +0.985%]")

if __name__ == '__main__':
    main()