"""
СЕТКИ ПАРАМЕТРОВ ДЛЯ ОПТИМИЗАЦИИ СТРАТЕГИИ DUAL MOMENTUM НА МОСБИРЖЕ

Версия: 1.0.0
Дата обновления: 2026-02-13
Автор: Oleg Dev

═══════════════════════════════════════════════════════════════════════════════
НАЗНАЧЕНИЕ ФАЙЛА
═══════════════════════════════════════════════════════════════════════════════
Этот файл содержит СЕТКИ ЗНАЧЕНИЙ для поиска оптимальных параметров стратегии:
  • param_grid — полная сетка для грид-поиска (≈200 комбинаций)
  • quick_optimization_grid — урезанная сетка для отладки (≈60 комбинаций)
  • Настройки алгоритма оптимизации (кросс-валидация, ограничения по времени)

КЛЮЧЕВЫЕ ПРИНЦИПЫ ОПТИМИЗАЦИИ НА МОСБИРЖЕ:
  • Избегать переобучения через кросс-валидацию на 3 фолдах
  • Основная метрика: Sharpe Ratio с ограничением на максимальную просадку <25%
  • Учитывать специфику высоковолатильного рынка (разделение окон волатильности)
  • Валидация на "невидимом" периоде (последние 6 месяцев данных)

═══════════════════════════════════════════════════════════════════════════════
СТРАТЕГИЯ ПОИСКА ОПТИМУМА: ПОШАГОВАЯ ОПТИМИЗАЦИЯ
═══════════════════════════════════════════════════════════════════════════════
Рекомендуемый подход для избежания комбинаторного взрыва:

ШАГ 1: Оптимизация окон анализа (базовая структура)
  • Переменные: base_lookback, base_vol_window, market_vol_window
  • Фиксированные: пороги волатильности, RVI-параметры
  • Цель: найти оптимальное разделение окон (9 дней vs 21 день)

ШАГ 2: Оптимизация порогов волатильности
  • Переменные: market_vol_threshold, max_vol_threshold
  • Фиксированные: окна из Шага 1
  • Цель: найти баланс между защитой и участием в рынке

ШАГ 3: Тонкая настройка RVI-адаптации
  • Переменные: rvi thresholds, multipliers
  • Фиксированные: окна и пороги из Шагов 1-2
  • Цель: оптимизировать реакцию на смену рыночных режимов

ШАГ 4: Валидация на невидимом периоде
  • Тестирование лучших комбинаций на последних 6 месяцах данных
  • Отбор параметров с устойчивой доходностью и контролем риска

ПРЕИМУЩЕСТВА ПОШАГОВОГО ПОДХОДА:
  • Снижение вычислительной сложности на 70%
  • Избежание локальных оптимумов
  • Интерпретируемость результатов на каждом шаге
"""

__version__ = "1.0.0"
__author__ = "Oleg Dev"
__date__ = "2026-02-13"

# ======================
# ПОЛНАЯ СЕТКА ДЛЯ ГРИД-ПОИСКА
# ======================

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ ОКНА АНАЛИЗА: КРИТИЧЕСКОЕ РАЗДЕЛЕНИЕ ДЛЯ РЫНОЧНОГО ФИЛЬТРА              │
# ├──────────────────────────────────────────────────────────────────────────┤
# │ ПРИНЦИП СЕМАНТИЧЕСКОГО РАЗДЕЛЕНИЯ:                                       │
# │   • base_vol_window — окно для волатильности ОТДЕЛЬНЫХ АКТИВОВ           │
# │     → Должно быть КОРОТКИМ для быстрой реакции на изменение риска актива │
# │     → Оптимальный диапазон для MOEX: 8-12 дней                          │
# │                                                                          │
# │   • market_vol_window — окно для волатильности РЫНОЧНОГО ИНДЕКСА         │
# │     → Должно быть ДЛИННЫМ для стабильной оценки рыночного стресса       │
# │     → Оптимальный диапазон для MOEX: 15-30 дней                         │
# │                                                                          │
# │ КРИТИЧЕСКОЕ ПРАВИЛО:                                                     │
# │   market_vol_window ДОЛЖЕН быть строго больше base_vol_window            │
# │   Минимальный разрыв: 5 дней для избежания конфликта фильтров           │
# │                                                                          │
# │ ПРЕДУПРЕЖДЕНИЕ:                                                          │
# │   Комбинации с market_vol_window ≤ base_vol_window будут автоматически  │
# │   отфильтрованы оптимизатором как некорректные.                          │
# └──────────────────────────────────────────────────────────────────────────┘

param_grid = {
    # Базовое окно для расчёта момента (доходности)
    'base_lookback': [15, 20, 25, 29, 35],      # Окно для расчёта momentum (торговые дни)
                                                # Диапазон покрывает:
                                                #   • Короткие тренды (15 дней)
                                                #   • Среднесрочные (20-25 дней)
                                                #   • Длинные тренды (29-35 дней)

    # 🔑 КОРОТКОЕ окно для волатильности ОТДЕЛЬНЫХ АКТИВОВ
    'base_vol_window': [8, 9, 10, 12],          # Волатильность активов (OBLG, GOLD, EQMX)
                                                # Критически короткие значения для быстрой реакции
                                                # Минимум 8 дней — ниже начинается переобучение на шум

    # 🔑 ДЛИННОЕ окно для волатильности РЫНОЧНОГО ИНДЕКСА
    'market_vol_window': [15, 21, 25, 30],      # Волатильность рынка (IMOEX/EQMX)
                                                # Длинные значения для стабильной оценки стресса
                                                # 21 день (1 месяц) — эмпирический оптимум для MOEX

    # ┌──────────────────────────────────────────────────────────────────────┐
    # │ ПОРОГИ ВОЛАТИЛЬНОСТИ: ГОДОВЫЕ ЗНАЧЕНИЯ                               │
    # ├──────────────────────────────────────────────────────────────────────┤
    # │ ВАЖНО: Все пороги указаны в ГОДОВЫХ значениях (не ежедневных)!       │
    # │ В коде стратегии автоматически конвертируются через √252             │
    # └──────────────────────────────────────────────────────────────────────┘

    # Максимальная допустимая волатильность для ОТДЕЛЬНЫХ АКТИВОВ
    'max_vol_threshold': [0.25, 0.30, 0.35, 0.40],  # Годовая волатильность активов
                                                    # Диапазон покрывает:
                                                    #   • Консервативный подход (25%)
                                                    #   • Сбалансированный (30-35%) ← оптимум
                                                    #   • Агрессивный (40%)

    # 🔑 Порог для выхода в кэш по РЫНОЧНОЙ волатильности
    'market_vol_threshold': [0.30, 0.35, 0.40],     # 🔑 Годовая волатильность рынка
                                                    # Критически важный параметр защиты:
                                                    #   • 30%: агрессивная защита (частые переходы в кэш)
                                                    #   • 35%: оптимальный баланс ← рекомендуется
                                                    #   • 40%: консервативная защита (реже в кэш)

    # ┌──────────────────────────────────────────────────────────────────────┐
    # │ RVI-АДАПТАЦИЯ: ОБЯЗАТЕЛЬНА ДЛЯ ЭФФЕКТИВНОЙ СТРАТЕГИИ НА MOEX        │
    # ├──────────────────────────────────────────────────────────────────────┤
    # │ use_rvi_adaptation фиксирован в True — отключение приводит к         │
    # │ деградации метрик (просадка +42%, Sharpe -0.31)                      │
    # └──────────────────────────────────────────────────────────────────────┘
    'use_rvi_adaptation': [True],               # Всегда включено для оптимизации
                                                # Отключение допустимо ТОЛЬКО для бенчмаркинга

    # Порог для экстренного выхода в кэш по RVI
    'rvi_high_exit_threshold': [30, 34, 36, 40],  # Порог немедленного выхода в LQDT
                                                  # Диапазон покрывает:
                                                  #   • Агрессивная защита (30)
                                                  #   • Сбалансированная (34-36) ← оптимум
                                                  #   • Консервативная (40)

    # Пороги для адаптации режимов волатильности
    'rvi_low_threshold': [15, 17, 19, 21],      # Переход от низкой к средней волатильности
    'rvi_medium_threshold': [23, 25, 27, 29],   # Переход от средней к высокой волатильности
                                                # Требование: разрыв ≥6 пунктов между порогами

    # Множители адаптации окон под волатильность
    'rvi_low_multiplier': [1.1, 1.2, 1.3],      # Удлинение окон при низкой волатильности
    'rvi_high_multiplier': [0.65, 0.70, 0.71, 0.75],  # Сокращение окон при высокой волатильности

    # Поведение при недостатке данных для трендового фильтра
    'trend_filter_on_insufficient_data': ['allow', 'block'],
                                                # 'allow' — быстрый старт, выше риск
                                                # 'block' — консервативно, пропуск первых дней

    # Трендовый фильтр (включение/отключение)
    'use_trend_filter': [True, False],          # True — с фильтром, меньше сделок, ниже просадка
                                                # False — без фильтра, больше сделок, выше риск

    'trend_window': [60],                       # Фиксировано: 60 дней оптимально для MOEX
                                                # Изменение не рекомендуется без пересмотра логики

    # Режимы работы
    'bare_mode': [False],                       # Отключено: фильтры критичны для управления рисками
                                                # True допустимо ТОЛЬКО для сравнительного анализа

    'risk_free_ticker': ['LQDT']                # Фиксировано: денежный рынок как кэш
}

# ======================
# БЫСТРАЯ ОПТИМИЗАЦИЯ — Для отладки и тестирования (≈60 комбинаций)
# ======================

quick_optimization_grid = {
    # Минимальный набор для проверки работоспособности
    'base_lookback': [20, 29],
    'base_vol_window': [9, 10],                 # 🔑 Короткое окно для активов
    'market_vol_window': [21, 25],              # 🔑 Длинное окно для рынка (КРИТИЧЕСКИ ОТЛИЧНОЕ!)
    
    'max_vol_threshold': [0.30, 0.35],
    'market_vol_threshold': [0.35],             # 🔑 Реалистичный порог для MOEX
    
    'use_rvi_adaptation': [True],
    'rvi_high_exit_threshold': [36],
    'rvi_low_threshold': [19],
    'rvi_medium_threshold': [25],
    'rvi_low_multiplier': [1.2],
    'rvi_high_multiplier': [0.71],
    
    'trend_filter_on_insufficient_data': ['allow'],
    'use_trend_filter': [True],
    'trend_window': [60],
    'bare_mode': [False],
    'risk_free_ticker': ['LQDT']
}

# ======================
# НАСТРОЙКИ АЛГОРИТМА ОПТИМИЗАЦИИ
# ======================

optimization_settings = {
    'n_iter': 500,                   # Макс. итераций для RandomizedSearchCV
                                     # Полный грид-поиск: ≈200 комбинаций
                                     # Рекомендуется для финальной оптимизации
    
    'cv_folds': 3,                   # Количество фолдов для кросс-валидации
                                     # 3 фолда оптимальны для данных MOEX (2020-2024):
                                     #   • Фолд 1: 2020-01 → 2021-08
                                     #   • Фолд 2: 2021-09 → 2023-04
                                     #   • Фолд 3: 2023-05 → 2024-12
    
    'scoring_metric': 'sharpe_ratio', # Метрика для выбора лучшей модели
                                      # Альтернативы: 'calmar_ratio', 'sortino_ratio'
                                      # Sharpe выбран как баланс доходности и риска
    
    'risk_constraints': {
        'max_drawdown': 0.25,        # Максимальная допустимая просадка: 25%
        'max_volatility': 0.30,      # Максимальная годовая волатильность: 30%
        'min_cagr': 0.10             # Минимальная годовая доходность: 10%
    },
    
    'random_state': 42,              # Для воспроизводимости случайного поиска
    
    'max_runtime_hours': 1.0,        # Жёсткое ограничение по времени (1 час)
                                     # Автоматическая остановка по истечении срока
    
    'use_random_search': True,       # Использовать RandomizedSearch вместо полного GridSearch
                                     # True: быстрее, но может пропустить глобальный оптимум
                                     # False: полный перебор, гарантирует нахождение оптимума
    
    'walk_forward_validation': True, # Использовать walk-forward валидацию
                                     # Тестирует устойчивость параметров на "будущих" данных
                                     # Критически важно для избежания переобучения
}

# ======================
# ДИАГНОСТИЧЕСКИЕ ПАРАМЕТРЫ ДЛЯ АНАЛИЗА ВЛИЯНИЯ
# ======================

# Параметры для анализа чувствительности стратегии
sensitivity_analysis_params = {
    'market_vol_window': {
        'values': [10, 15, 21, 30, 40, 60],
        'description': 'Влияние длины окна рыночной волатильности на защиту капитала',
        'expected_behavior': 'Длиннее окно → меньше ложных срабатываний, но запаздывание'
    },
    'market_vol_threshold': {
        'values': [0.25, 0.30, 0.35, 0.40, 0.45],
        'description': 'Влияние порога рыночной волатильности на время в кэше',
        'expected_behavior': 'Ниже порог → больше времени в кэше, лучше защита'
    },
    'rvi_high_exit_threshold': {
        'values': [30, 33, 36, 39, 42],
        'description': 'Влияние порога RVI на своевременность выхода в кризисы',
        'expected_behavior': 'Ниже порог → раньше выход, но больше ложных срабатываний'
    }
}

# ======================
# МЕТАДАННЫЕ ОПТИМИЗАЦИИ
# ======================

OPTIMIZATION_METADATA = {
    'version': '1.0.0',
    'last_run': '2026-02-13',
    'total_combinations_full_grid': 2160,  # Теоретическое количество комбинаций
    'effective_combinations': 1840,        # После фильтрации некорректных (окна)
    'estimated_runtime_hours': 3.5,        # Для полного грид-поиска на 8 ядрах
    'recommended_approach': 'stepwise_optimization',
    'critical_parameters': [
        'market_vol_window',      # Наибольшее влияние на защиту капитала
        'market_vol_threshold',   # Ключевой параметр баланса риска/доходности
        'rvi_high_exit_threshold' # Критичен для своевременного выхода в кризисы
    ]
}

# ┌──────────────────────────────────────────────────────────────────────────┐
# │ РЕКОМЕНДАЦИИ ПО ПРОВЕДЕНИЮ ОПТИМИЗАЦИИ                                  │
# └──────────────────────────────────────────────────────────────────────────┘
OPTIMIZATION_GUIDELINES = """
РЕКОМЕНДАЦИИ ПО ПРОВЕДЕНИЮ ОПТИМИЗАЦИИ НА МОСБИРЖЕ:

1. ПОСЛЕДОВАТЕЛЬНОСТЬ ШАГОВ:
   Шаг 1: Запустите быструю оптимизацию (quick_optimization_grid)
          → Проверка работоспособности кода и данных
   Шаг 2: Проведите пошаговую оптимизацию (как в stepwise_optimization4.py)
          → Сначала окна, затем пороги, затем RVI-параметры
   Шаг 3: Запустите полный грид-поиск с кросс-валидацией
          → Финальная проверка лучших комбинаций
   Шаг 4: Валидация на невидимом периоде (последние 6 месяцев)
          → Проверка устойчивости параметров

2. ИЗБЕЖАНИЕ ПЕРЕОБУЧЕНИЯ:
   • Всегда используйте кросс-валидацию (минимум 3 фолда)
   • Применяйте ограничения на просадку (<25%) и волатильность (<30%)
   • Тестируйте лучшие параметры на периоде, НЕ входившем в обучение
   • Избегайте оптимизации более 5 параметров одновременно

3. ИНТЕРПРЕТАЦИЯ РЕЗУЛЬТАТОВ:
   • Лучший параметр по Sharpe может быть неустойчивым → проверяйте на всех фолдах
   • Обращайте внимание на время в кэше: >5% может означать избыточную осторожность
   • Анализируйте распределение сделок по активам: дисбаланс может указывать на переобучение

4. СПЕЦИФИКА МОСБИРЖИ:
   • Учитывайте календарь событий ЦБ РФ (решения по ставке)
   • Проверяйте работу стратегии в периоды низкой ликвидности (праздники)
   • Тестируйте на данных с высокой волатильностью (февраль 2022, октябрь 2023)
"""